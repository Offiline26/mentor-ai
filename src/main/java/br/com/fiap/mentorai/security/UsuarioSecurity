package br.com.fiap.mentorai.security;

import br.com.fiap.mentorai.repository.UsuarioRepository;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;

import java.util.UUID;

@Component("usuarioSecurity") // Nomeia o bean para uso no @PreAuthorize
public class UsuarioSecurity {

    private final UsuarioRepository usuarioRepository;

    public UsuarioSecurity(UsuarioRepository usuarioRepository) {
        this.usuarioRepository = usuarioRepository;
    }

    /**
     * Checa se o ID requisitado na URL pertence ao usuário logado.
     * @param idRequisitado O ID que veio na URL ({idUsuario}).
     * @return true se o ID for do usuário logado ou se o usuário logado for ADMIN.
     */
    public boolean isOwner(UUID idRequisitado) {
        // 1. Pega o principal (dados do usuário logado)
        var authentication = SecurityContextHolder.getContext().getAuthentication();
        
        // 2. Se for um ADMIN, sempre permite. (Adicione 'ROLE_ADMIN' em UsuarioUserDetailsService)
        if (authentication.getAuthorities().stream().anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN"))) {
            return true; 
        }

        // 3. Pega o email (username) do principal logado
        String emailLogado = authentication.getName();

        // 4. Busca o ID real do usuário logado no banco (se necessário, ou em um cache local)
        // Como o principal só tem o email, buscamos o ID dele para comparação.
        return usuarioRepository.findByEmail(emailLogado)
                .map(u -> u.getId().equals(idRequisitado)) // Compara o ID logado com o ID da URL
                .orElse(false); 
    }
}
