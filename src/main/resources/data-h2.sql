-- =======================
--  Mentor-AI (H2)
--  FULL SCHEMA + SEED
-- =======================

-- ========== DROPS (ordem segura)
DROP TABLE IF EXISTS usuario_rota;
DROP TABLE IF EXISTS rota_curso;
DROP TABLE IF EXISTS curso_habilidade;
DROP TABLE IF EXISTS usuario_habilidade;
DROP TABLE IF EXISTS rotas_requalificacao;
DROP TABLE IF EXISTS cursos;
DROP TABLE IF EXISTS habilidades;
DROP TABLE IF EXISTS usuarios;
DROP TABLE IF EXISTS tendencias_mercado;
DROP TABLE IF EXISTS categorias_curso;
DROP TABLE IF EXISTS parceiros_curso;
DROP TABLE IF EXISTS categorias_habilidade;
DROP TABLE IF EXISTS areas_atuacao;
DROP TABLE IF EXISTS generos;
DROP TABLE IF EXISTS cargos;

-- ========== TABELAS BASE

CREATE TABLE cargos (
                        id_cargo     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                        nome_cargo   VARCHAR(100) NOT NULL,
                        descricao    CLOB,
                        CONSTRAINT cargos_nome_uk UNIQUE (nome_cargo)
);

CREATE TABLE generos (
                         id_genero     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                         nome_genero   VARCHAR(30) NOT NULL,
                         CONSTRAINT generos_nome_uk UNIQUE (nome_genero)
);

CREATE TABLE areas_atuacao (
                               id_area     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                               nome_area   VARCHAR(100) NOT NULL,
                               descricao   CLOB,
                               CONSTRAINT areas_atuacao_nome_uk UNIQUE (nome_area)
);

CREATE TABLE categorias_habilidade (
                                       id_cat_hab     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                       nome_cat_hab   VARCHAR(100) NOT NULL,
                                       descricao      CLOB,
                                       CONSTRAINT cat_habilidade_nome_uk UNIQUE (nome_cat_hab)
);

CREATE TABLE parceiros_curso (
                                 id_parceiro     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                 nome_parceiro   VARCHAR(150) NOT NULL,
                                 descricao       CLOB,
                                 CONSTRAINT parceiros_curso_nome_uk UNIQUE (nome_parceiro)
);

CREATE TABLE categorias_curso (
                                  id_cat_curso     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                  nome_cat_curso   VARCHAR(100) NOT NULL,
                                  descricao        CLOB,
                                  CONSTRAINT cat_curso_nome_uk UNIQUE (nome_cat_curso)
);

CREATE TABLE tendencias_mercado (
                                    id_tendencia     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                    descricao        CLOB NOT NULL,
                                    indice_demanda   DECIMAL(6,2),
                                    fonte            VARCHAR(100),
                                    data_analise     DATE
);

-- ========== USUÁRIOS / HABILIDADES / CURSOS / ROTAS

CREATE TABLE usuarios (
                          id_usuario        INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          nome              VARCHAR(100) NOT NULL,
                          email             VARCHAR(100) NOT NULL,
                          senha_hash        VARCHAR(255) NOT NULL,
                          data_nascimento   DATE,
                          id_genero         INTEGER,
                          pais              VARCHAR(50),
                          id_cargo          INTEGER NOT NULL,
                          id_area           INTEGER NOT NULL,
                          data_cadastro     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                          CONSTRAINT usuarios_email_uk UNIQUE (email),
                          CONSTRAINT usuarios_cargo_fk FOREIGN KEY (id_cargo) REFERENCES cargos(id_cargo) ON DELETE RESTRICT,
                          CONSTRAINT usuarios_area_fk  FOREIGN KEY (id_area)  REFERENCES areas_atuacao(id_area) ON DELETE RESTRICT,
                          CONSTRAINT usuarios_genero_fk FOREIGN KEY (id_genero) REFERENCES generos(id_genero) ON DELETE SET NULL
);

CREATE TABLE habilidades (
                             id_habilidade   INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                             nome            VARCHAR(100) NOT NULL,
                             id_cat_hab      INTEGER,
                             descricao       CLOB,
                             CONSTRAINT habilidades_cat_fk FOREIGN KEY (id_cat_hab) REFERENCES categorias_habilidade(id_cat_hab) ON DELETE SET NULL
);

CREATE TABLE cursos (
                        id_curso        INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                        titulo          VARCHAR(150) NOT NULL,
                        descricao       CLOB,
                        duracao_horas   DECIMAL(4,1),
                        id_parceiro     INTEGER,
                        link_curso      VARCHAR(255),
                        id_cat_curso    INTEGER,
                        CONSTRAINT cursos_parceiro_fk FOREIGN KEY (id_parceiro) REFERENCES parceiros_curso(id_parceiro) ON DELETE SET NULL,
                        CONSTRAINT cursos_cat_fk      FOREIGN KEY (id_cat_curso) REFERENCES categorias_curso(id_cat_curso) ON DELETE SET NULL
);

CREATE TABLE rotas_requalificacao (
                                      id_rota                 INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                      nome_rota               VARCHAR(150) NOT NULL,
                                      descricao               CLOB,
                                      objetivo_profissional   VARCHAR(150),
                                      id_tendencia            INTEGER,
                                      gerada_por_ia           BOOLEAN DEFAULT TRUE NOT NULL,
                                      CONSTRAINT rotas_tend_fk FOREIGN KEY (id_tendencia) REFERENCES tendencias_mercado(id_tendencia) ON DELETE SET NULL
);

-- ========== TABELAS DE LIGAÇÃO

CREATE TABLE usuario_habilidade (
                                    id_usuario           INTEGER NOT NULL,
                                    id_habilidade        INTEGER NOT NULL,
                                    nivel_proficiencia   INTEGER,
                                    CONSTRAINT usuario_habilidade_pk PRIMARY KEY (id_usuario, id_habilidade),
                                    CONSTRAINT usuhab_usuario_fk    FOREIGN KEY (id_usuario)    REFERENCES usuarios(id_usuario)    ON DELETE CASCADE,
                                    CONSTRAINT usuhab_habilidade_fk FOREIGN KEY (id_habilidade) REFERENCES habilidades(id_habilidade) ON DELETE CASCADE,
                                    CONSTRAINT usuhab_nivel_ck CHECK (nivel_proficiencia BETWEEN 1 AND 5)
);

CREATE TABLE curso_habilidade (
                                  id_curso       INTEGER NOT NULL,
                                  id_habilidade  INTEGER NOT NULL,
                                  CONSTRAINT curso_habilidade_pk PRIMARY KEY (id_curso, id_habilidade),
                                  CONSTRAINT curhab_curso_fk      FOREIGN KEY (id_curso)      REFERENCES cursos(id_curso)        ON DELETE CASCADE,
                                  CONSTRAINT curhab_habilidade_fk FOREIGN KEY (id_habilidade) REFERENCES habilidades(id_habilidade) ON DELETE CASCADE
);

CREATE TABLE rota_curso (
                            id_rota    INTEGER NOT NULL,
                            id_curso   INTEGER NOT NULL,
                            ordem      INTEGER,
                            CONSTRAINT rota_curso_pk PRIMARY KEY (id_rota, id_curso),
                            CONSTRAINT rotcur_rota_fk FOREIGN KEY (id_rota)  REFERENCES rotas_requalificacao(id_rota) ON DELETE CASCADE,
                            CONSTRAINT rotcur_curso_fk FOREIGN KEY (id_curso) REFERENCES cursos(id_curso)            ON DELETE CASCADE
);

CREATE TABLE usuario_rota (
                              id_usuario             INTEGER NOT NULL,
                              id_rota                INTEGER NOT NULL,
                              progresso_percentual   DECIMAL(5,2) DEFAULT 0,
                              data_inicio            TIMESTAMP,
                              data_conclusao         TIMESTAMP,
                              CONSTRAINT usuario_rota_pk PRIMARY KEY (id_usuario, id_rota),
                              CONSTRAINT usurto_usuario_fk FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario) ON DELETE CASCADE,
                              CONSTRAINT usurto_rota_fk    FOREIGN KEY (id_rota)    REFERENCES rotas_requalificacao(id_rota) ON DELETE CASCADE
);

-- =======================
-- SEED BÁSICO
-- =======================

-- CARGOS
INSERT INTO cargos (id_cargo, nome_cargo, descricao) VALUES
                                                         (1, 'ALUNO',  'Usuário padrão da plataforma'),
                                                         (2, 'MENTOR', 'Mentor humano de carreira'),
                                                         (3, 'ADMIN',  'Administrador do sistema');

-- GÊNEROS
INSERT INTO generos (id_genero, nome_genero) VALUES
                                                 (1, 'MASCULINO'),
                                                 (2, 'FEMININO'),
                                                 (3, 'OUTRO'),
                                                 (4, 'PREFIRO_NAO_INFORMAR');

-- ÁREAS
INSERT INTO areas_atuacao (id_area, nome_area, descricao) VALUES
                                                              (1, 'Tecnologia da Informação', 'Desenvolvimento de software, infraestrutura, QA, etc.'),
                                                              (2, 'Dados e IA', 'Ciência/Engenharia de Dados, ML, MLOps');

-- CATEGORIAS HABILIDADE
INSERT INTO categorias_habilidade (id_cat_hab, nome_cat_hab, descricao) VALUES
                                                                            (1, 'Programação', 'Linguagens, frameworks e práticas'),
                                                                            (2, 'Dados',        'Modelagem, ETL, análise, ML'),
                                                                            (3, 'Soft Skills',  'Competências comportamentais');

-- PARCEIROS
INSERT INTO parceiros_curso (id_parceiro, nome_parceiro, descricao) VALUES
                                                                        (1, 'FIAP',     'Parceiro FIAP'),
                                                                        (2, 'Coursera', 'Marketplace de cursos'),
                                                                        (3, 'Alura',    'Tecnologia e negócios');

-- CATEGORIAS DE CURSO
INSERT INTO categorias_curso (id_cat_curso, nome_cat_curso, descricao) VALUES
                                                                           (1, 'Microcurso', 'Conteúdo rápido'),
                                                                           (2, 'Trilha',     'Coleção de cursos'),
                                                                           (3, 'Bootcamp',   'Formação intensiva');

-- TENDÊNCIAS
INSERT INTO tendencias_mercado (id_tendencia, descricao, indice_demanda, fonte, data_analise) VALUES
                                                                                                  (1, 'Demanda crescente por Data Engineers no Brasil', 78.50, 'LinkedIn', DATE '2025-10-01'),
                                                                                                  (2, 'Back-end com Java/Spring segue sólido',          72.30, 'CAGED',    DATE '2025-09-20');

-- HABILIDADES
INSERT INTO habilidades (id_habilidade, nome, id_cat_hab, descricao) VALUES
                                                                         (1, 'Java',        1, 'Linguagem de programação'),
                                                                         (2, 'Spring Boot', 1, 'Framework Java'),
                                                                         (3, 'SQL',         2, 'Consultas e modelagem'),
                                                                         (4, 'Python',      1, 'Linguagem popular para dados'),
                                                                         (5, 'ML',          2, 'Machine Learning');

-- CURSOS
INSERT INTO cursos (id_curso, titulo, descricao, duracao_horas, id_parceiro, link_curso, id_cat_curso) VALUES
                                                                                                           (1, 'Java com Spring',   'Fundamentos modernos', 12.0, 1, 'https://fiap.com.br/java-spring', 1),
                                                                                                           (2, 'SQL Essencial',     'Do básico ao avançado', 8.0,  3, 'https://alura.com.br/sql',       1),
                                                                                                           (3, 'Introdução a ML',   'Conceitos de ML',      14.0, 2, 'https://coursera.org/ml',         1),
                                                                                                           (4, 'Python para Dados', 'Aplicado a dados',     10.0, 3, 'https://alura.com.br/python',     1);

-- CURSO x HABILIDADE
INSERT INTO curso_habilidade (id_curso, id_habilidade) VALUES
                                                           (1,1),(1,2),(2,3),(3,5),(4,4),(4,3);

-- ROTAS
INSERT INTO rotas_requalificacao (id_rota, nome_rota, descricao, objetivo_profissional, id_tendencia, gerada_por_ia) VALUES
                                                                                                                         (1, 'Transição para Data Engineer', 'Trilha para migrar de dev para dados', 'Atuar como Data Engineer em 12 meses', 1, TRUE),
                                                                                                                         (2, 'Back-end com Java',            'Aprofundar no ecossistema Spring',     'Evoluir para Dev Back-end Sênior',     2, FALSE);

-- TRILHA (ordem)
INSERT INTO rota_curso (id_rota, id_curso, ordem) VALUES
                                                      (1, 4, 1),
                                                      (1, 2, 2),
                                                      (1, 3, 3),
                                                      (2, 1, 1),
                                                      (2, 2, 2);

-- USUÁRIOS (admin + exemplo)
-- Hash BCrypt para "Admin@123" (a mesma que você usa no outro projeto)
-- $2b$10$mDn1QxWAF1esglWOvThEEurwjZ2V540nTbKd/lpPoQJsBwRIAEQxy
INSERT INTO usuarios (id_usuario, nome, email, senha_hash, data_nascimento, id_genero, pais, id_cargo, id_area, data_cadastro)
VALUES
    (1, 'Administrador', 'admin@mentorai.com', '$2b$10$mDn1QxWAF1esglWOvThEEurwjZ2V540nTbKd/lpPoQJsBwRIAEQxy', NULL, NULL, 'Brasil', 3, 1, CURRENT_TIMESTAMP),
    (2, 'Usuário Demo',  'demo@mentorai.com',  '$2b$10$mDn1QxWAF1esglWOvThEEurwjZ2V540nTbKd/lpPoQJsBwRIAEQxy', DATE '1995-08-15', 2, 'Brasil', 1, 2, CURRENT_TIMESTAMP);

-- Habilidades do usuário demo
INSERT INTO usuario_habilidade (id_usuario, id_habilidade, nivel_proficiencia) VALUES
                                                                                   (2, 1, 3),   -- Java
                                                                                   (2, 3, 4);   -- SQL

-- Progresso inicial do usuário demo (rota 2 - Java)
INSERT INTO usuario_rota (id_usuario, id_rota, progresso_percentual, data_inicio, data_conclusao)
VALUES (2, 2, 25.00, CURRENT_TIMESTAMP, NULL);
